# -*- coding: utf-8 -*-
"""speedtest.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1Sk9MVSmUaFBPEXcIU55VTDBxx5JmHjhO

# CSE5IDP Speedtest

**Downloading python package**

If you run it on your computer, you need to write the following command without the '!' before the pip command


You would need to execute the following command in your python enviornment/virtual enviornment:
```
pip install speedtest-cli
```

**GoogleColab-specific command:**
!pip install speedtest-cli

"""


"""**Speedtesting class**

Speedtesting class is designed to be scalable to do speedtest.net task and the custom speedtest task.
"""

import speedtest
import json
import socket
import requests

class Speedtesting:
  def __init__(self, custom = False):
    if not custom:
      self.speed_test = speedtest.Speedtest()
      self.speed_test.get_servers()
      self.speed_test.get_best_server()
      self.api_key = 'MSYZ8L99JXGS7CUW'

    else: #TODO to update else statement
      # It is supposed to do a speed test on latcs7 server
      raise NotImplementedError()

  #TODO to be implemented later
  def push_to_thingspeak(self, results_dictionary):
    _json = json.dumps(results_dictionary, indent = 4)
    url_str = f"https://api.thingspeak.com/update?api_key={self.api_key}&field1={results_dictionary['upload']}&field2={results_dictionary['download']}"
    print(url_str)
    response = requests.get(url_str)
    return response

  def test_upload_download(self, export = False):
    self.speed_test.download()
    self.speed_test.upload()
    res = self.speed_test.results.dict()
    if export:
      with open('results.json', 'w') as fp:
          json.dump(res, fp)
    return res

"""**Speedtest.net Usage Example:**"""

st = Speedtesting(custom = False)
for i in range(1,1000):
    print(f'Speed Test Iteration #{i}')
    result = st.test_upload_download(export = True)
    st.push_to_thingspeak(result)
